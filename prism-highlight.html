<!--
@license
Copyright 2018 The Advanced REST Client authors
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-progress/paper-progress.html">
<link rel="import" href="prism-import.html">
<link rel="import" href="prism-styles.html">
<dom-module id="prism-highlight">
  <template>
    <style include="prism-styles">
    :host {
      display: block;
      @apply --prism-highlight;
    }

    pre {
      -webkit-user-select: text;
      margin: 8px;
      @apply --prism-highlight-code;
    }

    paper-progress {
      width: 100%;
    }

    .worker-error {
      color: var(--error-color);
    }
    </style>
    <pre class="parsed-content"><code id="output" class="language-" on-click="_handleLinks"></code></pre>
    <template is="dom-if" if="[[hasMore]]">
      <div>
        <paper-button raised on-tap="_loadNext" data-action="load-next">Show next [[maxRead]] lines</paper-button>
        <paper-button raised on-tap="_loadAll" data-action="load-all">Display all</paper-button>
      </div>
    </template>
    <paper-progress indeterminate hidden$="[[!working]]"></paper-progress>
  </template>
  <script>
  /**
   * Syntax highlighting via Prism
   *
   * ### Example
   *
   * ```html
   * <prism-highlight id="c1" lang="markdown"></prism-highlight>
   * <script>
   *  document.querySelector('#c1').code = '# Test highlight';
   * &lt;/script>
   * ```
   *
   * The `lang` attribute is required and the component will not start parsing data without it.
   *
   * Changing the `lang` and `code` properties together, do it in less than 10 ms.
   * The element is set to commit changes after this persiod. Otherwise it may display
   * old and new code due to the asynchronius nature of the code highligter.
   *
   * **Note** This element uses web workers with dependencies. It expect to find
   * workers files in current directory in the `workers` folder.
   * Your build process has to ensure that this files will be avaiable.
   *
   * Also this element expects the prism scripts to be available in the same
   * root folder as this element is (like bower_components).
   *
   * ### Required scripts
   *
   * - ../prism/prism.js
   * - ../prism/plugins/autolinker/prism-autolinker.min.js
   * - ../prism/components/*
   *
   * ### Styling
   *
   * `<prism-highlight>` provides the following custom properties and mixins for styling:
   *
   * Custom property | Description | Default
   * ----------------|-------------|----------
   * `--prism-highlight` | Mixin applied to the element | `{}`
   * `--prism-highlight-code` | Mixin applied to the `<pre>` element | `{}`
   * `--error-color` | Color of the error message when script error ocurred in the worker | ``
   *
   * @customElement
   * @polymer
   * @demo demo/index.html
   * @memberof UiElements
   */
  class PrismHighlight extends Polymer.Element {
    static get is() { return 'prism-highlight'; }
    static get properties() {
      return {
        /**
         * A data to be highlighted and dispayed.
         */
        code: String,
        /**
         * Prism supported language.
         */
        lang: String,
        /**
         * A list of tokenized code.
         * It's a result of calling `Prism.tokenize` function.
         */
        tokenized: {
          type: Array,
          readOnly: true
        },
        /**
         * True if not all data has been displayed in the display.
         */
        hasMore: {
          type: Boolean,
          readOnly: true,
          computed: '_computeHasMore(tokenized)'
        },
        /**
         * A number of Prism tokens to process at once.
         * Note, that elements like paragraphs, list items etc consists of
         * two tokens: description and content while regular text can be
         * consoisted of single token.
         *
         * After the limit is reached the display shows "load next
         * [maxRead] items" and "load all" buttons.
         */
        maxRead: {
          type: Number,
          value: 500
        },
        // True when parsing code or tokens to HTML code.
        working: {
          type: Boolean,
          value: false,
          readOnly: true
        },
        // A web worker instance that parses the syntax
        worker: {
          type: Object,
          readOnly: true
        },
        /**
         * Number of miliseconds after which the tokenize task fail sending
         * `prism-highlight-timeout` event.
         * Set to "falsy" value to remove timeout.
         */
        tokenizeTimeout: {
          type: Number,
          value: 5000
        }
      };
    }

    static get observers() {
      return ['_highlight(code, lang)'];
    }

    /**
     * @constructor
     */
    constructor() {
      super();
      this._onWorkerData = this._onWorkerData.bind(this);
      this._onWorkerError = this._onWorkerError.bind(this);
      this._onTokenizeTimeout = this._onTokenizeTimeout.bind(this);
    }

    detached() {
      super.detached();
      this._unregisterWorker();
    }
    // Resets the state of the display to initial state.
    reset() {
      this._setTokenized(undefined);
      this._setWorking(false);
      this.$.output.innerHTML = '';
    }
    /**
     * Hightligt the code.
     * @param {String} data The code to be highlighted
     * @param {String} mime Mime type to be used to recognize the language.
     */
    _highlight(code, lang) {
      if (!code || !lang) {
        return;
      }
      this.reset();
      if (this._highlightDebounce) {
        return;
      }
      this._highlightDebounce = true;
      setTimeout(() => {
        this._highlightDebounce = false;
        const message = {
          language: this.lang,
          code: this.code,
          payload: 'tokenize'
        };
        this._runWorker(message);
      }, 10);
    }
    /**
     * Sends message to the hightligt worker if its already created.
     * If not, this will create worker and then post message.
     * @param {Object} message An object to pass to the worker.
     */
    _runWorker(message) {
      this._setWorking(true);
      if (!this.worker) {
        this._registerWorker();
      }
      this.worker.postMessage(message);
      const timeout = this.tokenizeTimeout;
      if (timeout) {
        this._tokenizeTimeout = window.setTimeout(this._onTokenizeTimeout, timeout);
      }
    }
    /**
     * Clears the tokenize timeout if set.
     */
    _clearTokenizeTimeout() {
      if (!this._tokenizeTimeout) {
        return;
      }
      window.clearTimeout(this._tokenizeTimeout);
      this._tokenizeTimeout = undefined;
    }
    /**
     * Creates an instance of a web worker.
     * It does nothing if the worker is already created.
     */
    _registerWorker() {
      if (this.worker) {
        return;
      }
      const worker = new Worker(this.resolveUrl('workers/prism-worker.js'));
      worker.addEventListener('message', this._onWorkerData);
      worker.addEventListener('error', this._onWorkerError);
      this._setWorker(worker);
    }
    /**
     * Terminates the worker (if exists) and removes event listeners
     */
    _unregisterWorker() {
      if (!this.worker) {
        return;
      }
      this._clearTokenizeTimeout();
      this.worker.removeEventListener('message', this._onWorkerData);
      this.worker.removeEventListener('error', this._onWorkerError);
      this.worker.terminate();
      this._setWorker(undefined);
    }
    /**
     * Handler for the worker `message` event
     *
     * @param {Event} e
     */
    _onWorkerData(e) {
      this._setWorking(false);
      this._clearTokenizeTimeout();
      switch (e.data.payload) {
        case 'error':
          this._renderWorkerError();
          this._notifyError(e.data);
          console.warn(e.data);
          break;
        case 'tokenize':
          this._onTokenized(e.data.tokens);
          break;
        case 'stringify':
          this._display(e.data.html);
          this.dispatchEvent(new CustomEvent('prism-highlight-parsed', {
            bubbles: false,
          }));
          break;
      }
    }
    /**
     * Renders fallback view when there was a script error in the worker.
     */
    _renderWorkerError() {
      const p = document.createElement('p');
      p.className = 'worker-error';
      p.innerText = 'Script error. Displaying unprocessed data.';
      this.$.output.innerHTML = '';
      this.$.output.appendChild(p);
      const div = document.createElement('div');
      div.className = 'raw-content';
      div.innerText = this.code;
      this.$.output.appendChild(div);
      this._setTokenized(undefined);
    }
    /**
     * Dispatches `error` event
     *
     * @param {Error} e
     */
    _notifyError(e) {
      this.dispatchEvent(new CustomEvent('error', {
        bubbles: false,
        detail: {
          message: e.message
        }
      }));
    }
    /**
     * Handler for worker error.
     *
     * @param {Error} e
     */
    _onWorkerError(e) {
      this._setWorking(false);
      this._clearTokenizeTimeout();
      this._renderWorkerError();
      this._notifyError(e);
      this.dispatchEvent(new CustomEvent('app-log', {
        bubbles: true,
        composed: true,
        detail: {
          message: e,
          level: 'error'
        }
      }));
    }
    /**
     * Handler for worker function after code tokenization.
     *
     * @param {Array} tokens An array of tokens returnet by Prism.
     */
    _onTokenized(tokens) {
      this._setTokenized(tokens);
      this._loadNext();
    }
    /**
     * Display next tokens from `this.tokenized` list - up to `this.maxRead`
     * elements. If after running this function the `this.tokenized`
     * array is empty it will be set to undefined.
     */
    _loadNext() {
      if (!this.tokenized || this.tokenized.length === 0) {
        return;
      }
      const tokens = this.splice('tokenized', 0, this.maxRead);
      const message = {
        tokens: tokens,
        payload: 'stringify'
      };
      this._runWorker(message);
      if (this.tokenized.length === 0) {
        this._setTokenized(undefined);
      }
    }

    _loadAll() {
      const tokens = this.tokenized;
      this._setTokenized(undefined);
      const message = {
        tokens: tokens,
        payload: 'stringify'
      };
      this._runWorker(message);
    }
    /**
     * Display a HTML code generated by Prism.
     * @param {String} html HTML code to be displayed.
     */
    _display(html) {
      this.$.output.innerHTML += html;
    }
    // Computes if the element has more data to display.
    _computeHasMore(tokenized) {
      if (!tokenized || tokenized.length === 0) {
        return false;
      }
      return true;
    }
    /**
     * Handler for click events.
     * It dispatches `url-change-action` custom event when a link is clicked.
     *
     * @param {ClickEvent} e
     */
    _handleLinks(e) {
      var el = e.target;
      if (el.nodeName !== 'A') {
        return;
      }
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      this.dispatchEvent(new CustomEvent('url-change-action', {
        cancelable: true,
        bubbles: true,
        composed: true,
        detail: {
          url: el.href
        }
      }));
    }
    /**
     * Called when the tokenize task exceeds timeout set in the `tokenizeTimeout`
     * property
     */
    _onTokenizeTimeout() {
      this._setWorking(false);
      this._unregisterWorker();
      const message = 'Highlighter is unable to highlight the syntax.';
      this.dispatchEvent(new CustomEvent('prism-highlight-timeout', {
        cancelable: true,
        bubbles: false,
        detail: {
          message: message
        }
      }));
    }
    /**
     * An event fired when the user clicked on any link in the response
     * panels or the headers
     *
     * @event url-change-action
     * @param {String} url An url value
     */
    /**
     * Fired when the tokenize task timeout.
     *
     * - This event is cancelable.
     * - This does not bubbles.
     *
     * @event prism-highlight-timeout
     * @param {String} message A message to display to the user.
     */
    /**
     * Fired when highlighting is applied to the code view.
     *
     * @event prism-highlight-parsed
     */
  }
  window.customElements.define(PrismHighlight.is, PrismHighlight);
  </script>
</dom-module>
